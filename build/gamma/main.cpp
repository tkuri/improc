
#include <fstream>
#include <iostream>
#include <opencv2/opencv.hpp>

//! 0:sRGB, 1:ISGamma, 2:3PointGamma
const int gammaMode = 0;

const double idx[1024] = 
{
0.0,0.000977517,0.001955034,0.002932551,0.003910068,0.004887586,0.005865103,0.00684262,0.007820137,0.008797654,0.009775171,0.010752688,0.011730205,0.012707722,0.013685239,0.014662757,0.015640274,0.016617791,0.017595308,0.018572825,0.019550342,0.020527859,0.021505376,0.022482893,0.023460411,0.024437928,0.025415445,0.026392962,0.027370479,0.028347996,0.029325513,0.03030303,0.031280547,0.032258065,0.033235582,0.034213099,0.035190616,0.036168133,0.03714565,0.038123167,0.039100684,0.040078201,0.041055718,0.042033236,0.043010753,0.04398827,0.044965787,0.045943304,0.046920821,0.047898338,0.048875855,0.049853372,0.05083089,0.051808407,0.052785924,0.053763441,0.054740958,0.055718475,0.056695992,0.057673509,0.058651026,0.059628543,0.060606061,0.061583578,0.062561095,0.063538612,0.064516129,0.065493646,0.066471163,0.06744868,0.068426197,0.069403715,0.070381232,0.071358749,0.072336266,0.073313783,0.0742913,0.075268817,0.076246334,0.077223851,0.078201369,0.079178886,0.080156403,0.08113392,0.082111437,0.083088954,0.084066471,0.085043988,0.086021505,0.086999022,0.08797654,0.088954057,0.089931574,0.090909091,0.091886608,0.092864125,0.093841642,0.094819159,0.095796676,0.096774194,0.097751711,0.098729228,0.099706745,0.100684262,0.101661779,0.102639296,0.103616813,0.10459433,0.105571848,0.106549365,0.107526882,0.108504399,0.109481916,0.110459433,0.11143695,0.112414467,0.113391984,0.114369501,0.115347019,0.116324536,0.117302053,0.11827957,0.119257087,0.120234604,0.121212121,0.122189638,0.123167155,0.124144673,0.12512219,0.126099707,0.127077224,0.128054741,0.129032258,0.130009775,0.130987292,0.131964809,0.132942326,0.133919844,0.134897361,0.135874878,0.136852395,0.137829912,0.138807429,0.139784946,0.140762463,0.14173998,0.142717498,0.143695015,0.144672532,0.145650049,0.146627566,0.147605083,0.1485826,0.149560117,0.150537634,0.151515152,0.152492669,0.153470186,0.154447703,0.15542522,0.156402737,0.157380254,0.158357771,0.159335288,0.160312805,0.161290323,0.16226784,0.163245357,0.164222874,0.165200391,0.166177908,0.167155425,0.168132942,0.169110459,0.170087977,0.171065494,0.172043011,0.173020528,0.173998045,0.174975562,0.175953079,0.176930596,0.177908113,0.17888563,0.179863148,0.180840665,0.181818182,0.182795699,0.183773216,0.184750733,0.18572825,0.186705767,0.187683284,0.188660802,0.189638319,0.190615836,0.191593353,0.19257087,0.193548387,0.194525904,0.195503421,0.196480938,0.197458456,0.198435973,0.19941349,0.200391007,0.201368524,0.202346041,0.203323558,0.204301075,0.205278592,0.206256109,0.207233627,0.208211144,0.209188661,0.210166178,0.211143695,0.212121212,0.213098729,0.214076246,0.215053763,0.216031281,0.217008798,0.217986315,0.218963832,0.219941349,0.220918866,0.221896383,0.2228739,0.223851417,0.224828935,0.225806452,0.226783969,0.227761486,0.228739003,0.22971652,0.230694037,0.231671554,0.232649071,0.233626588,0.234604106,0.235581623,0.23655914,0.237536657,0.238514174,0.239491691,0.240469208,0.241446725,0.242424242,0.24340176,0.244379277,0.245356794,0.246334311,0.247311828,0.248289345,0.249266862,0.250244379,0.251221896,0.252199413,0.253176931,0.254154448,0.255131965,0.256109482,0.257086999,0.258064516,0.259042033,0.26001955,0.260997067,0.261974585,0.262952102,0.263929619,0.264907136,0.265884653,0.26686217,0.267839687,0.268817204,0.269794721,0.270772239,0.271749756,0.272727273,0.27370479,0.274682307,0.275659824,0.276637341,0.277614858,0.278592375,0.279569892,0.28054741,0.281524927,0.282502444,0.283479961,0.284457478,0.285434995,0.286412512,0.287390029,0.288367546,0.289345064,0.290322581,0.291300098,0.292277615,0.293255132,0.294232649,0.295210166,0.296187683,0.2971652,0.298142717,0.299120235,0.300097752,0.301075269,0.302052786,0.303030303,0.30400782,0.304985337,0.305962854,0.306940371,0.307917889,0.308895406,0.309872923,0.31085044,0.311827957,0.312805474,0.313782991,0.314760508,0.315738025,0.316715543,0.31769306,0.318670577,0.319648094,0.320625611,0.321603128,0.322580645,0.323558162,0.324535679,0.325513196,0.326490714,0.327468231,0.328445748,0.329423265,0.330400782,0.331378299,0.332355816,0.333333333,0.33431085,0.335288368,0.336265885,0.337243402,0.338220919,0.339198436,0.340175953,0.34115347,0.342130987,0.343108504,0.344086022,0.345063539,0.346041056,0.347018573,0.34799609,0.348973607,0.349951124,0.350928641,0.351906158,0.352883675,0.353861193,0.35483871,0.355816227,0.356793744,0.357771261,0.358748778,0.359726295,0.360703812,0.361681329,0.362658847,0.363636364,0.364613881,0.365591398,0.366568915,0.367546432,0.368523949,0.369501466,0.370478983,0.3714565,0.372434018,0.373411535,0.374389052,0.375366569,0.376344086,0.377321603,0.37829912,0.379276637,0.380254154,0.381231672,0.382209189,0.383186706,0.384164223,0.38514174,0.386119257,0.387096774,0.388074291,0.389051808,0.390029326,0.391006843,0.39198436,0.392961877,0.393939394,0.394916911,0.395894428,0.396871945,0.397849462,0.398826979,0.399804497,0.400782014,0.401759531,0.402737048,0.403714565,0.404692082,0.405669599,0.406647116,0.407624633,0.408602151,0.409579668,0.410557185,0.411534702,0.412512219,0.413489736,0.414467253,0.41544477,0.416422287,0.417399804,0.418377322,0.419354839,0.420332356,0.421309873,0.42228739,0.423264907,0.424242424,0.425219941,0.426197458,0.427174976,0.428152493,0.42913001,0.430107527,0.431085044,0.432062561,0.433040078,0.434017595,0.434995112,0.43597263,0.436950147,0.437927664,0.438905181,0.439882698,0.440860215,0.441837732,0.442815249,0.443792766,0.444770283,0.445747801,0.446725318,0.447702835,0.448680352,0.449657869,0.450635386,0.451612903,0.45259042,0.453567937,0.454545455,0.455522972,0.456500489,0.457478006,0.458455523,0.45943304,0.460410557,0.461388074,0.462365591,0.463343109,0.464320626,0.465298143,0.46627566,0.467253177,0.468230694,0.469208211,0.470185728,0.471163245,0.472140762,0.47311828,0.474095797,0.475073314,0.476050831,0.477028348,0.478005865,0.478983382,0.479960899,0.480938416,0.481915934,0.482893451,0.483870968,0.484848485,0.485826002,0.486803519,0.487781036,0.488758553,0.48973607,0.490713587,0.491691105,0.492668622,0.493646139,0.494623656,0.495601173,0.49657869,0.497556207,0.498533724,0.499511241,0.500488759,0.501466276,0.502443793,0.50342131,0.504398827,0.505376344,0.506353861,0.507331378,0.508308895,0.509286413,0.51026393,0.511241447,0.512218964,0.513196481,0.514173998,0.515151515,0.516129032,0.517106549,0.518084066,0.519061584,0.520039101,0.521016618,0.521994135,0.522971652,0.523949169,0.524926686,0.525904203,0.52688172,0.527859238,0.528836755,0.529814272,0.530791789,0.531769306,0.532746823,0.53372434,0.534701857,0.535679374,0.536656891,0.537634409,0.538611926,0.539589443,0.54056696,0.541544477,0.542521994,0.543499511,0.544477028,0.545454545,0.546432063,0.54740958,0.548387097,0.549364614,0.550342131,0.551319648,0.552297165,0.553274682,0.554252199,0.555229717,0.556207234,0.557184751,0.558162268,0.559139785,0.560117302,0.561094819,0.562072336,0.563049853,0.56402737,0.565004888,0.565982405,0.566959922,0.567937439,0.568914956,0.569892473,0.57086999,0.571847507,0.572825024,0.573802542,0.574780059,0.575757576,0.576735093,0.57771261,0.578690127,0.579667644,0.580645161,0.581622678,0.582600196,0.583577713,0.58455523,0.585532747,0.586510264,0.587487781,0.588465298,0.589442815,0.590420332,0.591397849,0.592375367,0.593352884,0.594330401,0.595307918,0.596285435,0.597262952,0.598240469,0.599217986,0.600195503,0.601173021,0.602150538,0.603128055,0.604105572,0.605083089,0.606060606,0.607038123,0.60801564,0.608993157,0.609970674,0.610948192,0.611925709,0.612903226,0.613880743,0.61485826,0.615835777,0.616813294,0.617790811,0.618768328,0.619745846,0.620723363,0.62170088,0.622678397,0.623655914,0.624633431,0.625610948,0.626588465,0.627565982,0.6285435,0.629521017,0.630498534,0.631476051,0.632453568,0.633431085,0.634408602,0.635386119,0.636363636,0.637341153,0.638318671,0.639296188,0.640273705,0.641251222,0.642228739,0.643206256,0.644183773,0.64516129,0.646138807,0.647116325,0.648093842,0.649071359,0.650048876,0.651026393,0.65200391,0.652981427,0.653958944,0.654936461,0.655913978,0.656891496,0.657869013,0.65884653,0.659824047,0.660801564,0.661779081,0.662756598,0.663734115,0.664711632,0.66568915,0.666666667,0.667644184,0.668621701,0.669599218,0.670576735,0.671554252,0.672531769,0.673509286,0.674486804,0.675464321,0.676441838,0.677419355,0.678396872,0.679374389,0.680351906,0.681329423,0.68230694,0.683284457,0.684261975,0.685239492,0.686217009,0.687194526,0.688172043,0.68914956,0.690127077,0.691104594,0.692082111,0.693059629,0.694037146,0.695014663,0.69599218,0.696969697,0.697947214,0.698924731,0.699902248,0.700879765,0.701857283,0.7028348,0.703812317,0.704789834,0.705767351,0.706744868,0.707722385,0.708699902,0.709677419,0.710654936,0.711632454,0.712609971,0.713587488,0.714565005,0.715542522,0.716520039,0.717497556,0.718475073,0.71945259,0.720430108,0.721407625,0.722385142,0.723362659,0.724340176,0.725317693,0.72629521,0.727272727,0.728250244,0.729227761,0.730205279,0.731182796,0.732160313,0.73313783,0.734115347,0.735092864,0.736070381,0.737047898,0.738025415,0.739002933,0.73998045,0.740957967,0.741935484,0.742913001,0.743890518,0.744868035,0.745845552,0.746823069,0.747800587,0.748778104,0.749755621,0.750733138,0.751710655,0.752688172,0.753665689,0.754643206,0.755620723,0.75659824,0.757575758,0.758553275,0.759530792,0.760508309,0.761485826,0.762463343,0.76344086,0.764418377,0.765395894,0.766373412,0.767350929,0.768328446,0.769305963,0.77028348,0.771260997,0.772238514,0.773216031,0.774193548,0.775171065,0.776148583,0.7771261,0.778103617,0.779081134,0.780058651,0.781036168,0.782013685,0.782991202,0.783968719,0.784946237,0.785923754,0.786901271,0.787878788,0.788856305,0.789833822,0.790811339,0.791788856,0.792766373,0.793743891,0.794721408,0.795698925,0.796676442,0.797653959,0.798631476,0.799608993,0.80058651,0.801564027,0.802541544,0.803519062,0.804496579,0.805474096,0.806451613,0.80742913,0.808406647,0.809384164,0.810361681,0.811339198,0.812316716,0.813294233,0.81427175,0.815249267,0.816226784,0.817204301,0.818181818,0.819159335,0.820136852,0.82111437,0.822091887,0.823069404,0.824046921,0.825024438,0.826001955,0.826979472,0.827956989,0.828934506,0.829912023,0.830889541,0.831867058,0.832844575,0.833822092,0.834799609,0.835777126,0.836754643,0.83773216,0.838709677,0.839687195,0.840664712,0.841642229,0.842619746,0.843597263,0.84457478,0.845552297,0.846529814,0.847507331,0.848484848,0.849462366,0.850439883,0.8514174,0.852394917,0.853372434,0.854349951,0.855327468,0.856304985,0.857282502,0.85826002,0.859237537,0.860215054,0.861192571,0.862170088,0.863147605,0.864125122,0.865102639,0.866080156,0.867057674,0.868035191,0.869012708,0.869990225,0.870967742,0.871945259,0.872922776,0.873900293,0.87487781,0.875855327,0.876832845,0.877810362,0.878787879,0.879765396,0.880742913,0.88172043,0.882697947,0.883675464,0.884652981,0.885630499,0.886608016,0.887585533,0.88856305,0.889540567,0.890518084,0.891495601,0.892473118,0.893450635,0.894428152,0.89540567,0.896383187,0.897360704,0.898338221,0.899315738,0.900293255,0.901270772,0.902248289,0.903225806,0.904203324,0.905180841,0.906158358,0.907135875,0.908113392,0.909090909,0.910068426,0.911045943,0.91202346,0.913000978,0.913978495,0.914956012,0.915933529,0.916911046,0.917888563,0.91886608,0.919843597,0.920821114,0.921798631,0.922776149,0.923753666,0.924731183,0.9257087,0.926686217,0.927663734,0.928641251,0.929618768,0.930596285,0.931573803,0.93255132,0.933528837,0.934506354,0.935483871,0.936461388,0.937438905,0.938416422,0.939393939,0.940371457,0.941348974,0.942326491,0.943304008,0.944281525,0.945259042,0.946236559,0.947214076,0.948191593,0.94916911,0.950146628,0.951124145,0.952101662,0.953079179,0.954056696,0.955034213,0.95601173,0.956989247,0.957966764,0.958944282,0.959921799,0.960899316,0.961876833,0.96285435,0.963831867,0.964809384,0.965786901,0.966764418,0.967741935,0.968719453,0.96969697,0.970674487,0.971652004,0.972629521,0.973607038,0.974584555,0.975562072,0.976539589,0.977517107,0.978494624,0.979472141,0.980449658,0.981427175,0.982404692,0.983382209,0.984359726,0.985337243,0.986314761,0.987292278,0.988269795,0.989247312,0.990224829,0.991202346,0.992179863,0.99315738,0.994134897,0.995112414,0.996089932,0.997067449,0.998044966,0.999022483,1
};
const double value[1024] = 
{
0.0,0.005865103,0.009775171,0.013685239,0.017595308,0.021505376,0.029325513,0.033235582,0.03714565,0.041055718,0.044965787,0.048875855,0.056695992,0.060606061,0.064516129,0.068426197,0.072336266,0.076246334,0.080156403,0.084066471,0.08797654,0.091886608,0.095796676,0.099706745,0.107526882,0.11143695,0.11143695,0.115347019,0.119257087,0.123167155,0.127077224,0.130987292,0.134897361,0.138807429,0.142717498,0.146627566,0.150537634,0.154447703,0.154447703,0.158357771,0.16226784,0.166177908,0.170087977,0.170087977,0.173998045,0.177908113,0.181818182,0.18572825,0.18572825,0.189638319,0.193548387,0.197458456,0.197458456,0.201368524,0.205278592,0.209188661,0.209188661,0.213098729,0.217008798,0.217008798,0.220918866,0.224828935,0.228739003,0.228739003,0.232649071,0.23655914,0.240469208,0.240469208,0.244379277,0.248289345,0.248289345,0.252199413,0.256109482,0.256109482,0.26001955,0.263929619,0.267839687,0.267839687,0.271749756,0.275659824,0.275659824,0.279569892,0.283479961,0.287390029,0.287390029,0.291300098,0.295210166,0.295210166,0.299120235,0.303030303,0.306940371,0.306940371,0.31085044,0.314760508,0.314760508,0.318670577,0.322580645,0.322580645,0.326490714,0.330400782,0.330400782,0.33431085,0.338220919,0.342130987,0.342130987,0.346041056,0.349951124,0.349951124,0.353861193,0.357771261,0.357771261,0.361681329,0.365591398,0.365591398,0.369501466,0.373411535,0.373411535,0.377321603,0.377321603,0.381231672,0.38514174,0.38514174,0.389051808,0.392961877,0.392961877,0.396871945,0.400782014,0.400782014,0.404692082,0.404692082,0.408602151,0.412512219,0.412512219,0.416422287,0.416422287,0.420332356,0.424242424,0.424242424,0.428152493,0.428152493,0.432062561,0.432062561,0.43597263,0.43597263,0.439882698,0.443792766,0.443792766,0.447702835,0.447702835,0.451612903,0.451612903,0.455522972,0.455522972,0.45943304,0.45943304,0.463343109,0.463343109,0.467253177,0.467253177,0.471163245,0.471163245,0.475073314,0.475073314,0.478983382,0.478983382,0.482893451,0.482893451,0.486803519,0.490713587,0.490713587,0.494623656,0.494623656,0.498533724,0.498533724,0.502443793,0.502443793,0.502443793,0.506353861,0.506353861,0.51026393,0.51026393,0.514173998,0.514173998,0.518084066,0.518084066,0.521994135,0.521994135,0.525904203,0.525904203,0.529814272,0.529814272,0.53372434,0.53372434,0.537634409,0.537634409,0.541544477,0.541544477,0.545454545,0.545454545,0.549364614,0.549364614,0.553274682,0.553274682,0.557184751,0.557184751,0.561094819,0.561094819,0.565004888,0.565004888,0.568914956,0.568914956,0.572825024,0.572825024,0.576735093,0.576735093,0.576735093,0.580645161,0.580645161,0.58455523,0.58455523,0.588465298,0.588465298,0.592375367,0.592375367,0.596285435,0.596285435,0.596285435,0.600195503,0.600195503,0.604105572,0.604105572,0.60801564,0.60801564,0.611925709,0.611925709,0.611925709,0.615835777,0.615835777,0.619745846,0.619745846,0.623655914,0.623655914,0.623655914,0.627565982,0.627565982,0.631476051,0.631476051,0.631476051,0.635386119,0.635386119,0.639296188,0.639296188,0.639296188,0.643206256,0.643206256,0.643206256,0.647116325,0.647116325,0.651026393,0.651026393,0.651026393,0.654936461,0.654936461,0.654936461,0.65884653,0.65884653,0.662756598,0.662756598,0.662756598,0.666666667,0.666666667,0.666666667,0.670576735,0.670576735,0.670576735,0.674486804,0.674486804,0.674486804,0.678396872,0.678396872,0.678396872,0.68230694,0.68230694,0.68230694,0.686217009,0.686217009,0.686217009,0.686217009,0.690127077,0.690127077,0.690127077,0.694037146,0.694037146,0.694037146,0.697947214,0.697947214,0.697947214,0.701857283,0.701857283,0.701857283,0.701857283,0.705767351,0.705767351,0.705767351,0.709677419,0.709677419,0.709677419,0.709677419,0.713587488,0.713587488,0.713587488,0.713587488,0.717497556,0.717497556,0.717497556,0.717497556,0.721407625,0.721407625,0.721407625,0.721407625,0.725317693,0.725317693,0.725317693,0.725317693,0.729227761,0.729227761,0.729227761,0.729227761,0.73313783,0.73313783,0.73313783,0.73313783,0.737047898,0.737047898,0.737047898,0.737047898,0.740957967,0.740957967,0.740957967,0.740957967,0.744868035,0.744868035,0.744868035,0.744868035,0.744868035,0.748778104,0.748778104,0.748778104,0.748778104,0.752688172,0.752688172,0.752688172,0.752688172,0.752688172,0.75659824,0.75659824,0.75659824,0.75659824,0.760508309,0.760508309,0.760508309,0.760508309,0.760508309,0.764418377,0.764418377,0.764418377,0.764418377,0.764418377,0.768328446,0.768328446,0.768328446,0.768328446,0.772238514,0.772238514,0.772238514,0.772238514,0.772238514,0.776148583,0.776148583,0.776148583,0.776148583,0.776148583,0.780058651,0.780058651,0.780058651,0.780058651,0.780058651,0.783968719,0.783968719,0.783968719,0.783968719,0.783968719,0.787878788,0.787878788,0.787878788,0.787878788,0.787878788,0.791788856,0.791788856,0.791788856,0.791788856,0.791788856,0.795698925,0.795698925,0.795698925,0.795698925,0.795698925,0.799608993,0.799608993,0.799608993,0.799608993,0.799608993,0.803519062,0.803519062,0.803519062,0.803519062,0.803519062,0.803519062,0.80742913,0.80742913,0.80742913,0.80742913,0.80742913,0.811339198,0.811339198,0.811339198,0.811339198,0.811339198,0.811339198,0.815249267,0.815249267,0.815249267,0.815249267,0.815249267,0.815249267,0.819159335,0.819159335,0.819159335,0.819159335,0.819159335,0.819159335,0.823069404,0.823069404,0.823069404,0.823069404,0.823069404,0.823069404,0.826979472,0.826979472,0.826979472,0.826979472,0.826979472,0.826979472,0.826979472,0.830889541,0.830889541,0.830889541,0.830889541,0.830889541,0.830889541,0.834799609,0.834799609,0.834799609,0.834799609,0.834799609,0.834799609,0.834799609,0.838709677,0.838709677,0.838709677,0.838709677,0.838709677,0.838709677,0.838709677,0.842619746,0.842619746,0.842619746,0.842619746,0.842619746,0.842619746,0.842619746,0.842619746,0.846529814,0.846529814,0.846529814,0.846529814,0.846529814,0.846529814,0.846529814,0.846529814,0.850439883,0.850439883,0.850439883,0.850439883,0.850439883,0.850439883,0.850439883,0.850439883,0.854349951,0.854349951,0.854349951,0.854349951,0.854349951,0.854349951,0.854349951,0.854349951,0.85826002,0.85826002,0.85826002,0.85826002,0.85826002,0.85826002,0.85826002,0.85826002,0.85826002,0.862170088,0.862170088,0.862170088,0.862170088,0.862170088,0.862170088,0.862170088,0.862170088,0.866080156,0.866080156,0.866080156,0.866080156,0.866080156,0.866080156,0.866080156,0.866080156,0.866080156,0.869990225,0.869990225,0.869990225,0.869990225,0.869990225,0.869990225,0.869990225,0.869990225,0.869990225,0.873900293,0.873900293,0.873900293,0.873900293,0.873900293,0.873900293,0.873900293,0.873900293,0.873900293,0.877810362,0.877810362,0.877810362,0.877810362,0.877810362,0.877810362,0.877810362,0.877810362,0.877810362,0.88172043,0.88172043,0.88172043,0.88172043,0.88172043,0.88172043,0.88172043,0.88172043,0.88172043,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.885630499,0.889540567,0.889540567,0.889540567,0.889540567,0.889540567,0.889540567,0.889540567,0.889540567,0.889540567,0.889540567,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.893450635,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.897360704,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.901270772,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.905180841,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.909090909,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.913000978,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.916911046,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.920821114,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.924731183,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.928641251,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.93255132,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.936461388,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.940371457,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.944281525,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.948191593,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.952101662,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.95601173,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.959921799,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.963831867,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.967741935,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.971652004,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.975562072,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.979472141,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.983382209,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.987292278,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.991202346,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.995112414,0.999022483
};

const float gammaCoeff = 2.2f;


/*!
 * ファイル名から拡張子を削除
 * @param[in] fn ファイル名(フルパス or 相対パス)
 * @return フォルダパス
 */
inline std::string ExtractPathWithoutExt(const std::string &fn)
{
    std::string::size_type pos;
    if((pos = fn.find_last_of(".")) == std::string::npos){
        return fn;
    }
 
    return fn.substr(0, pos);
}

int getIndex(float value)
{
	int index = 0;
	for(int i = 1022 ; i >= 0 ; i--)
	{
		if(value >= idx[i]){
			if(fabs(idx[i + 1] - value) < fabs(idx[i] - value)){
				index = i + 1;
			}
			else{
				index = i;
			}
			break;
		}

	}
	return index;

}

cv::Mat Gamma(const cv::Mat& src)
{
	cv::Mat dst = src.clone();

#pragma omp parallel for
	for( int y = 0 ; y < src.rows ; y++ )
	{
		for( int x = 0 ; x < src.cols ; x++ )
		{
			cv::Vec3f v = src.at<cv::Vec3f>(y, x);
			cv::Vec3i index;
			for(int c = 0; c < 3; c++){
				index[c] = getIndex(v[c]);
				v[c] = static_cast<float>(value[index[c]]);
			}
			dst.at<cv::Vec3f>(y, x) = v;
		}
	}
	return dst;

}

cv::Mat Gamma3Point(const cv::Mat& src)
{
	cv::Mat dst = src.clone();

	const float gamma_coefficients[3] = {
		1.6f, 2.2f, 1.6f
		//1.5f, 2.5f, 6.0f
	};

    const float param_gamma_coefficients[3] = {
        1.0f / gamma_coefficients[0],
        1.0f / gamma_coefficients[1],
        1.0f / gamma_coefficients[2]
    };


#pragma omp parallel for
	for( int y = 0 ; y < src.rows ; y++ )
	{
		for( int x = 0 ; x < src.cols ; x++ )
		{
			cv::Vec3f v = src.at<cv::Vec3f>(y, x);
			for(int c = 0; c < 3; c++){
				v[c] = std::max(v[c], 0.0f);

				float pixel_gm[3];
                for (int i = 0; i < 3; ++i){
                    pixel_gm[i] = pow(v[c], param_gamma_coefficients[i]);
                }
				float pixel_out;
                if (pixel_gm[1] < 0.5f){
                    auto blend_ratio = pixel_gm[1] * 2.0f;
                    pixel_out = pixel_gm[0] * (1.0f - blend_ratio) + pixel_gm[1] * blend_ratio;
                }
                else{
                    auto blend_ratio = (pixel_gm[1] - 0.5f) * 2.0f;
                    pixel_out = pixel_gm[1] * (1.0f - blend_ratio) + pixel_gm[2] * blend_ratio;
                }
				v[c] = pixel_out;
			}
			dst.at<cv::Vec3f>(y, x) = v;
		}
	}
	return dst;

}

int main( int argc, char** argv )
{
	if(argc < 2) return 1;

	std::string file;
	cv::Mat img;
	cv::Mat dst;


	for(int n=1; n<argc; n++){

		file = argv[n];

		img = cv::imread( file.c_str(),  6 );
		if(img.data==NULL) break;

		cv::Mat tmp;
		if(img.depth()==2){
			img.convertTo(tmp, CV_32FC3, 1.0f/65535.0f);
		}
		else{
			img.convertTo(tmp, CV_32FC3, 1.0f/255.0f);
		}

		if(gammaMode==0){
			cv::pow(tmp, 1.0f/gammaCoeff, tmp);
		}
		else if(gammaMode==1){
			cv::Mat tmp2 = Gamma(tmp);
			tmp = tmp2;
		}
		else{
			cv::Mat tmp2 = Gamma3Point(tmp);
			tmp = tmp2;
		}

		if(img.depth()==2){
			tmp.convertTo(dst, img.type(), 65535.0f);
		}
		else{
			tmp.convertTo(dst, img.type(), 255.0f);
		}

		std::string ofile = ExtractPathWithoutExt(file);
		ofile += "_gamma.png";

		cv::imwrite( ofile.c_str(), dst);
	}

	std::cout << "Profile finished. ";
	

	return 0;	
}

